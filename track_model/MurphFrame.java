/*
 * Roger Xue
 *
 * A JFrame that can be used to simulate track failures.
 */
package track_model;

import java.util.ArrayList;
import javax.swing.DefaultComboBoxModel;

public class MurphFrame extends javax.swing.JFrame {

	// JTable data used to populate dropdowns
	private final ArrayList<TrackBlock> blocks;
	// Database helper
	private final DbHelper dbHelper;

	/**
	 * Creates new form MurphFrame
	 *
	 * @param blocks
	 * @param dbHelper
	 */
	public MurphFrame(ArrayList<TrackBlock> blocks, DbHelper dbHelper) {
		initComponents();
		this.blocks = blocks;
		this.dbHelper = dbHelper;
		if (TrackModel.doTablesExist()) {
			populateDropdown();
		} else {
			//
			// Disables buttons if no track data.
			//
			breakPowerButton.setEnabled(false);
			breakRailButton.setEnabled(false);
			breakTrackCircuitButton.setEnabled(false);
		}
	}

	/**
	 * This method is called from within the constructor to
	 * initialize the form.
	 * WARNING: Do NOT modify this code. The content of this method is
	 * always regenerated by the Form Editor.
	 */
	@SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        blockComboBox = new javax.swing.JComboBox<>();
        breakRailButton = new javax.swing.JButton();
        selectBlockLabel = new javax.swing.JLabel();
        breakTrackCircuitButton = new javax.swing.JButton();
        breakPowerButton = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("Track Model Failure Tests");
        setResizable(false);

        blockComboBox.setMaximumRowCount(24);

        breakRailButton.setText("Broken Rail");
        breakRailButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                breakRailButtonActionPerformed(evt);
            }
        });

        selectBlockLabel.setText("Select Block:");

        breakTrackCircuitButton.setText("Track Circuit Failure");
        breakTrackCircuitButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                breakTrackCircuitButtonActionPerformed(evt);
            }
        });

        breakPowerButton.setText("Power Failure");
        breakPowerButton.setToolTipText("");
        breakPowerButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                breakPowerButtonActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(selectBlockLabel)
                        .addGap(18, 18, 18)
                        .addComponent(blockComboBox, 0, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(breakRailButton)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(breakTrackCircuitButton)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(breakPowerButton)
                        .addGap(0, 0, Short.MAX_VALUE)))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(blockComboBox, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(selectBlockLabel))
                .addGap(18, 18, 18)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(breakRailButton)
                    .addComponent(breakTrackCircuitButton)
                    .addComponent(breakPowerButton))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void breakRailButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_breakRailButtonActionPerformed
		breakTrack();
    }//GEN-LAST:event_breakRailButtonActionPerformed

    private void breakTrackCircuitButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_breakTrackCircuitButtonActionPerformed
		breakTrack();
    }//GEN-LAST:event_breakTrackCircuitButtonActionPerformed

    private void breakPowerButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_breakPowerButtonActionPerformed
		breakPower();
    }//GEN-LAST:event_breakPowerButtonActionPerformed
	/**
	 * Populates the drop down.
	 */
	private void populateDropdown() {
		ArrayList<String> blockList = new ArrayList<>();
		for (TrackBlock tb : blocks) {
			if (tb.block != 0) {
				blockList.add("Line: " + tb.line.toUpperCase() + ", Section: " + tb.section + ", Block: " + tb.block);
			}
		}
		blockComboBox.setModel(new DefaultComboBoxModel(blockList.toArray()));
	}

	/**
	 * Breaks a segment of the selected track block.
	 */
	private void breakTrack() {
		String line = blockComboBox.getSelectedItem().toString().split(",")[0];
		line = line.substring(line.lastIndexOf(" "), line.length()).trim();
		String block = blockComboBox.getSelectedItem().toString().split(",")[2];
		block = block.substring(block.lastIndexOf(" "), block.length()).trim();

		TrackModel.setMaintenance(line, Integer.parseInt(block), true);
	}

	/**
	 * Induces power outage on the selected track block.
	 */
	private void breakPower() {
		String line = blockComboBox.getSelectedItem().toString().split(",")[0];
		line = line.substring(line.lastIndexOf(" "), line.length()).trim();
		String block = blockComboBox.getSelectedItem().toString().split(",")[2];
		block = block.substring(block.lastIndexOf(" "), block.length()).trim();

		TrackModel.setPower(line, Integer.parseInt(block), false);
	}

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JComboBox<String> blockComboBox;
    private javax.swing.JButton breakPowerButton;
    private javax.swing.JButton breakRailButton;
    private javax.swing.JButton breakTrackCircuitButton;
    private javax.swing.JLabel selectBlockLabel;
    // End of variables declaration//GEN-END:variables
}
